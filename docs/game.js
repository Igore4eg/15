const fifteen={Move:{up:-4,left:-1,down:4,right:1},order:[...Array(16)].map((e,t)=>t={id:t+1,data:t}),getNull:function(){return k=this.order.findIndex(e=>0===e.id),k},findIndex:function(t){return k=this.order.findIndex(e=>e.id===+t),k},isCompleted:function(t){for(let e=0;e<t.length-1;e++)if(e+1!=t[e].id)return!1;return!0},go:function(e){let t=this.getNull();var i=t+e;return!!this.order[i]&&((e!==this.Move.left&&e!==this.Move.right||Math.floor(t/4)===Math.floor(i/4))&&(this.swap(i,t),t=i,!0))},swap:function(e,t){var i=this.order[e];this.order[e]=this.order[t],this.order[t]=i},getRandomInt:function(e,t){return Math.floor(Math.random()*(t-e+1))+e},getCellsForMovement:function(i){return[[i-1,"h"],[i+1,"h"],[i-4,"v"],[i+4,"v"]].filter(([e,t])=>"h"===t?Math.floor(e/4)===Math.floor(i/4):"v"===t?0<e&&e<16:0).map(([e])=>e)},mix:function(){var t=this.getRandomInt(50,500);for(let e=0;e<t;e++){var i=this.getNull(),n=this.getCellsForMovement(i),r=this.getRandomInt(0,n.length-1);this.swap(i,n[r])}}};let image=new Image;const importImage=document.body.appendChild(document.createElement("input"));async function inputFile(){return new Promise((e,t)=>{var i=document.querySelector("#inputFile").files[0];let n=new FileReader;n.onload=function(){image.src=n.result,image.onload=function(){e()}},n.onerror=t,n.readAsDataURL(i)})}async function startGame(){try{await inputFile(),cutImageUp(image),fifteen.mix(),draw(),drag()}catch(e){console.log(e)}}function cutImageUp(r){for(let n=0;n<4;++n)for(let i=0;i<4;++i){let e=document.createElement("canvas");e.width=r.width/4,e.height=r.height/4;let t=e.getContext("2d");t.drawImage(r,i*e.width,n*e.height,r.width/4,r.height/4,0,0,e.width,e.height);var o=4*n+i;fifteen.order[o].data=e.toDataURL()}fifteen.order[15].id=0,fifteen.order[15].data=0}importImage.type="file",importImage.id="inputFile",importImage.onchange=startGame;const box=document.body.appendChild(document.createElement("div"));box.setAttribute("id","box"),box.setAttribute("style","margin-top: 20px; width: 456px; border: solid 1px transparent;");for(let e=0;e<16;e++){let e=box.appendChild(document.createElement("div"));e.setAttribute("class","outerDiv"),e.setAttribute("style","display: inline-block; width: 100px; height: 100px; border: solid 2px gray; margin: 2px; text-align: center; background-color: whitesmoke; box-sizing: border-box");let t=e.appendChild(document.createElement("div"));t.setAttribute("class","innerDiv")}function draw(){let t=1;1e3<image.width&&(t=1e3/Math.max(image.width,image.height));var e=t*image.width+32;box.style.width=e+"px";let i=document.querySelectorAll("div.innerDiv"),n=0;i.forEach(e=>{e.style.width=t*image.width/4+"px",e.style.height=t*image.height/4+"px",e.style.maxWidth="200px",e.textContent=fifteen.order[n].id,e.id=fifteen.order[n].id,e.style.backgroundImage=`url('${fifteen.order[n].data}')`,e.style.backgroundRepeat="no-repeat",e.style.backgroundSize="contain",e.draggable=!1,e.style.opacity="1",n++});let r=document.querySelectorAll("div.outerDiv");r.forEach(e=>{e.style.width="unset",e.style.height="unset",e.style.backgroundColor="whitesmoke"}),drag()}function drag(){let e=document.querySelector(`[id='${fifteen.order[fifteen.getNull()].id}']`),t=fifteen.getCellsForMovement(fifteen.getNull()),i;const n=function(){this.style.opacity="0.5",i=this.id},r=function(){this.style.opacity="1"};t.forEach(function(e){let t=document.querySelector(`[id='${fifteen.order[e].id}']`);t.draggable=!0,t.addEventListener("dragstart",n),t.addEventListener("dragend",r)});e.addEventListener("dragenter",function(e){e.preventDefault(),this.style.backgroundColor="#20B2AA"}),e.addEventListener("dragleave",function(){this.style.backgroundColor="whitesmoke"}),e.addEventListener("dragover",function(e){e.preventDefault()}),e.addEventListener("drop",function(){fifteen.swap(fifteen.getNull(),fifteen.findIndex(i)),this.style.backgroundColor="whitesmoke"})}window.addEventListener("keydown",function(e){fifteen.go(fifteen.Move[{37:"left",39:"right",38:"up",40:"down"}[e.keyCode]])&&(draw(),drag(),fifteen.isCompleted(fifteen.order)&&(box.style.backgroundColor="gold",window.removeEventListener("keydown",arguments.callee)))});