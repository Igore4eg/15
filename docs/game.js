const fifteen={Move:{up:-4,left:-1,down:4,right:1},order:[...Array(16)].map((e,t)=>t={id:t+1,data:t}),getNull:function(){return k=this.order.findIndex(e=>0===e.id),k},findIndex:function(t){return k=this.order.findIndex(e=>e.id===+t),k},isCompleted:function(t){for(let e=0;e<t.length-1;e++)if(e+1!=t[e].id)return!1;return!0},go:function(e){let t=this.getNull();var r=t+e;return!!this.order[r]&&((e!==this.Move.left&&e!==this.Move.right||Math.floor(t/4)===Math.floor(r/4))&&(this.swap(r,t),t=r,[!0,t,t-e]))},swap:function(e,t){var r=this.order[e];this.order[e]=this.order[t],this.order[t]=r},getRandomInt:function(e,t){return Math.floor(Math.random()*(t-e+1))+e},getCellsForMovement:function(r){return[[r-1,"h"],[r+1,"h"],[r-4,"v"],[r+4,"v"]].filter(([e,t])=>"h"===t?Math.floor(e/4)===Math.floor(r/4):"v"===t?0<e&&e<16:0).map(([e])=>e)},mix:function(){var t=this.getRandomInt(50,500);for(let e=0;e<t;e++){var r=this.getNull(),n=this.getCellsForMovement(r),d=this.getRandomInt(0,n.length-1);this.swap(r,n[d])}}};let scores=0;function exchangeElements(e,t){const r=e.parentNode,n=t.parentNode;r.appendChild(t),n.appendChild(e),scores++,scoreOutput.value=scores}let image=new Image;const importImage=document.body.appendChild(document.createElement("input"));async function inputFile(){return new Promise((e,t)=>{var r=document.querySelector("#inputFile").files[0];let n=new FileReader;n.onload=function(){image.src=n.result,image.onload=function(){e()}},n.onerror=t,n.readAsDataURL(r)})}async function startGame(){try{await inputFile(),cutImageUp(image),importImage.hidden=!0,fifteen.mix(),draw(),drag(),mixGame.hidden=!1}catch(e){console.log(e)}}function cutImageUp(d){for(let n=0;n<4;++n)for(let r=0;r<4;++r){let e=document.createElement("canvas");e.width=d.width/4,e.height=d.height/4;let t=e.getContext("2d");t.drawImage(d,r*e.width,n*e.height,d.width/4,d.height/4,0,0,e.width,e.height);var i=4*n+r;fifteen.order[i].data=e.toDataURL()}fifteen.order[15].id=0,fifteen.order[15].data=null}importImage.type="file",importImage.id="inputFile",importImage.accept=".png, .jpg, .jpeg",importImage.addEventListener("change",startGame);const box=document.body.appendChild(document.createElement("div"));box.setAttribute("id","box");for(let e=0;e<16;e++){let e=box.appendChild(document.createElement("div"));e.setAttribute("class","outerDiv");let t=e.appendChild(document.createElement("div"));t.setAttribute("class","innerDiv")}let scoreOutput=document.createElement("input");scoreOutput.setAttribute("id","score"),box.after(scoreOutput),scoreOutput.value=scores,scoreOutput.setAttribute("readonly",!0);let mixGame=document.createElement("button");function draw(){let t=1;1e3<image.width&&(t=1e3/Math.max(image.width,image.height));var e=t*image.width+32;box.style.width=e+"px";let r=document.querySelectorAll("div.innerDiv"),n=0;r.forEach(e=>{e.style.width=t*image.width/4+"px",e.style.height=t*image.height/4+"px",e.style.maxWidth="200px",e.textContent=fifteen.order[n].id,e.id=fifteen.order[n].id,e.style.backgroundImage=`url('${fifteen.order[n].data}')`,e.style.backgroundRepeat="no-repeat",e.style.backgroundSize="contain",e.style.userSelect="none",n++}),addDraggable();let d=document.querySelectorAll("div.outerDiv");d.forEach(e=>{e.style.width="unset",e.style.height="unset",e.style.backgroundColor="whitesmoke"})}function addDraggable(){const e=fifteen.getCellsForMovement(fifteen.getNull());e.forEach(function(e){let t=document.querySelector(`[id='${fifteen.order[e].id}']`);t.draggable=!0})}function delDraggable(){let e=document.querySelectorAll("div.innerDiv");e.forEach(e=>{e.draggable=!1})}mixGame.setAttribute("id","mixGame"),mixGame.innerHTML="Mix",mixGame.hidden=!0,scoreOutput.after(mixGame),mixGame.onclick=function(){fifteen.mix(),removeAllEventDrag(),console.log("removeallevent"),draw(),delDraggable(),addDraggable(),drag(),scoreOutput.value=0},window.addEventListener("keydown",function(e){var t=fifteen.go(fifteen.Move[{37:"left",39:"right",38:"up",40:"down"}[e.keyCode]]);if(t[0]){exchangeElements(document.querySelector(`[id='${fifteen.order[t[1]].id}']`),document.querySelector(`[id='${fifteen.order[t[2]].id}']`)),delDraggable(),addDraggable();let e=fifteen.getCellsForMovement(fifteen.getNull());e.forEach(function(e){let t=document.querySelector(`[id='${fifteen.order[e].id}']`);t.addEventListener("dragstart",dragStart),t.addEventListener("dragend",dragEnd)}),fifteen.isCompleted(fifteen.order)&&(box.style.backgroundColor="gold",window.removeEventListener("keydown",arguments.callee),delDraggable(),removeAllEventDrag())}});const dragStart=function(e){this.style.opacity="0.5",e.dataTransfer.setData("text",e.target.id)},dragEnd=function(){this.style.opacity="1"},removeAllEventDrag=function(){let e=document.querySelectorAll("div.innerDiv");e.forEach(function(e){e.removeEventListener("dragstart",dragStart),e.removeEventListener("dragend",dragEnd),e.removeEventListener("dragenter",dragEnter),e.removeEventListener("dragleave",dragLeave),e.removeEventListener("dragover",dragOver),e.removeEventListener("drop",dragDrop)})},dragEnter=function(e){e.preventDefault(),this.style.backgroundColor="#20B2AA"},dragLeave=function(){this.style.backgroundColor="whitesmoke"},dragOver=function(e){e.preventDefault()},dragDrop=function(e){var t=document.querySelector(`[id='${fifteen.order[fifteen.getNull()].id}']`),r=e.dataTransfer.getData("text"),n=document.querySelector(`[id='${r}']`);fifteen.swap(fifteen.getNull(),fifteen.findIndex(r)),this.style.backgroundColor="whitesmoke",exchangeElements(t,n),delDraggable(),removeAllEventDrag(),addDraggable();let d=fifteen.getCellsForMovement(fifteen.getNull());d.forEach(function(e){let t=document.querySelector(`[id='${fifteen.order[e].id}']`);t.addEventListener("dragstart",dragStart),t.addEventListener("dragend",dragEnd)}),fifteen.isCompleted(fifteen.order)&&(box.style.backgroundColor="gold",window.removeEventListener("keydown",arguments.callee),delDraggable(),removeAllEventDrag())};function drag(){let e=document.querySelector(`[id='${fifteen.order[fifteen.getNull()].id}']`),t=fifteen.getCellsForMovement(fifteen.getNull());document.querySelectorAll("div.innerDiv");t.forEach(function(e){let t=document.querySelector(`[id='${fifteen.order[e].id}']`);t.addEventListener("dragstart",dragStart),t.addEventListener("dragend",dragEnd)}),e.addEventListener("dragenter",dragEnter),e.addEventListener("dragleave",dragLeave),e.addEventListener("dragover",dragOver),e.addEventListener("drop",dragDrop)}